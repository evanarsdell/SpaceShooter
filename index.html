<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mobile FP Space Shooter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <!-- Import Orbitron font -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100vw; height: 100vh;
      background: #0a172c;
      overflow: hidden; touch-action: none;
    }
    #canvas {
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 0; display: block; pointer-events: none;
    }
    #ui {
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 7; pointer-events: none;
      font-family: "Orbitron", monospace, Arial, sans-serif;
    }
    #shoot {
      position: fixed;
      right: 7vw; bottom: 12vh;
      width: 22vw; height: 22vw;
      min-width: 70px; min-height: 70px;
      max-width: 128px; max-height: 128px;
      background: linear-gradient(135deg, #27b2e7 65%, #0a2e4e 95%);
      border-radius:50%; border:2px solid #9cfffc;
      font-size:1.3em; color:#f5ffff; letter-spacing:.1em;
      font-weight:bold; text-shadow:0 2px 12px #3afcff96;
      box-shadow:0 1px 16px #42e5f755;
      pointer-events:auto; outline:none; opacity:.88;
    }
    #shoot:active { opacity:1; background:#9aecff }
    #overlay,#gameover,#calibrate {
      position:fixed; top:0; left:0;
      width:100vw; height:100vh;
      z-index:9; pointer-events:auto;
      background:rgba(10,24,44,.96);
      display:flex; align-items:center;
      justify-content:center; flex-direction:column;
      font-family:"Orbitron",monospace,Arial,sans-serif;
      font-size:1.15em; color:#e4ffff; text-align:center;
      user-select:none; -webkit-user-select:none;
    }
    #overlay,#gameover,#calibrate{display:none}
    .overlay-btn {
      background:#2beafc; color:#fff;
      font-size:1.1em; padding:.5em 2em;
      border:0; border-radius:.4em;
      margin-top:1em; box-shadow:0 0 16px #43f3ff80;
      cursor:pointer;
    }
    .info {
      position:fixed; left:7vw; bottom:8vw;
      font-size:.93em; color:#95e8ff67;
      z-index:8; pointer-events:none;
      text-shadow:0 2px 9px #1cf6ff40;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="ui">
    <button id="shoot">FIRE</button>
    <div class="info" id="helpInfo"></div>
  </div>
  <div id="overlay">
    <h2 style="font-size:2em;color:#5eeccf;">SPACE SHOOTER</h2>
    <div style="margin:.9em 0 1.6em 0;font-size:1.15em;">
      <b>Enable Motion on your Device</b><br>
      Tap to allow tilt-controls (iOS/Android).<br>
      Hold device as you want to aim.<br>
    </div>
    <button class="overlay-btn" id="permBtn">ENABLE MOTION</button>
  </div>
  <div id="calibrate">
    <h3 style="font-size:1.5em;color:#69f2e9;">Calibrate</h3>
    <div style="margin:.8em 0 1.2em 0;">
      Hold device FORWARD as you play.<br>
      <b>Tap to calibrate zero point.</b>
    </div>
    <button class="overlay-btn" id="calibBtn">Set Forward</button>
  </div>
  <div id="gameover">
    <div style="font-size:2.4em;color:#ff8f98;text-shadow:0 0 20px #fff3;">GAME OVER</div>
    <div id="finalscore" style="font-size:1.2em;margin:.7em 0 1.5em 0;"></div>
    <button class="overlay-btn" id="restartBtn">TAP TO RESTART</button>
  </div>

  <script>
    "use strict";

    // --- Configuration ---
    const CFG = {
      FOV: 62, SENS: 1.0, SCENED: 2000, SHIPRAD:34,
      SHIPSPEED:142, SHIPINERTIA:.12, SHIP_Y_BIAS:.11,
      LASER_COOLDOWN:.18, LASER_SPEED:1700, LASER_LENGTH:170,
      STARS:84, ASTEROIDS:7, AST_BIRATE:1.13,
      AST_MINZ:660, AST_MAXZ:1160, AST_MINR:32, AST_MAXR:66,
      AST_MINSPD:440, AST_MAXSPD:690,
      AST_COLORS:['#8cf7ff','#cab9ad','#aeaedb','#abf1e1','#eed7ba','#efacb0','#b9e4e8'],
      EXPLODE_FRAMES:18, PLAYER_HEALTH:4, COCKPIT_H:.17,
      DODGE_JITTER:8, SFX_VOL:.21
    };

    // --- Globals & DOM Elements ---
    let canvas, ctx, DPR, W, H, cx, cy, minWH;
    let stars, asteroids, lasers, explosions;
    let game, player, t0, tPrev;
    let deviceOk=false, calibrating=false, gameover=false, canFire=false;
    let orientationZero={beta:0,gamma:0}, haveInput=false, shootDown=false;
    let audioCtx=null, helpTimeout;

    const UI = {
      overlay:   document.getElementById('overlay'),
      permBtn:   document.getElementById('permBtn'),
      calibrate: document.getElementById('calibrate'),
      calibBtn:  document.getElementById('calibBtn'),
      gameover:  document.getElementById('gameover'),
      finalscore:document.getElementById('finalscore'),
      restartBtn:document.getElementById('restartBtn'),
      shoot:     document.getElementById('shoot'),
      help:      document.getElementById('helpInfo')
    };

    // --- Device Orientation & Calibration ---
    function requireDeviceMotionPermission(){
      if(typeof DeviceOrientationEvent==='undefined'){
        UI.overlay.style.display='flex';
        UI.permBtn.innerText='Device motion not supported';
        UI.permBtn.disabled=true;
        return;
      }
      if(typeof DeviceOrientationEvent.requestPermission==='function'){
        UI.overlay.style.display='flex';
        UI.permBtn.onclick = ()=>{
          DeviceOrientationEvent.requestPermission()
            .then(res=>{ if(res==='granted'){ UI.overlay.style.display='none'; deviceOk=true; beginCalibration(); }})
            .catch(console.error);
        };
      } else {
        deviceOk=true;
        UI.overlay.style.display='none';
        beginCalibration();
      }
    }

    window.addEventListener('deviceorientation', handleOrient, true);
    function handleOrient(evt){
      haveInput=true;
      player.lastRaw.beta  = evt.beta  || 0;
      player.lastRaw.gamma = evt.gamma || 0;
      player.lastRaw.alpha = evt.alpha || 0;
    }

    function beginCalibration(){
      calibrating=true;
      UI.calibrate.style.display='flex';
    }
    UI.calibBtn.onclick = ()=>{
      orientationZero.beta  = player.lastRaw.beta;
      orientationZero.gamma = player.lastRaw.gamma;
      calibrating=false;
      UI.calibrate.style.display='none';
    };

    // --- Game State & Initialization ---
    function initGame(){
      game = { running:true, score:0, health:CFG.PLAYER_HEALTH,
               lastAst:0, asteroidRate:CFG.AST_BIRATE, tLaser:-9, inShake:0 };
      player = { x:0,y:0,z:0,vx:0,vy:0,
                cross:{x:0,y:0}, lastRaw:{beta:0,gamma:0,alpha:0}};
      lasers=[]; asteroids=[]; explosions=[];
      stars = [];
      for(let i=0;i<CFG.STARS;++i){
        let s={ x:(Math.random()-0.5)*1.8*W,
                y:(Math.random()-0.5)*1.5*H,
                z:0.22+0.78*Math.random(),
                r:Math.random()*1.7+0.7,
                c:Math.random()<0.91?'#cceeff':'#6fddff' };
        stars.push(s);
      }
    }

    // --- Main Loop & Physics ---
    function loop(ts){
      if(!t0){ t0=tPrev=ts/1000; }
      const t=ts/1000, dt=Math.min(1/30,t-tPrev);
      tPrev=t;

      resizeIfNeeded();
      if(!deviceOk||calibrating){ requestAnimationFrame(loop); return; }
      if(!game.running){ render(); requestAnimationFrame(loop); return; }

      // Tilt → position
      const g=player.lastRaw;
      let dBeta = g.beta-orientationZero.beta,
          dGamma= g.gamma-orientationZero.gamma;
      const maxBeta=34, maxGamma=38;
      dBeta= Math.max(-maxBeta,Math.min(maxBeta,dBeta));
      dGamma=Math.max(-maxGamma,Math.min(maxGamma,dGamma));
      const tarY = -dBeta/maxBeta*(H*0.35),
            tarX =  dGamma/maxGamma*(W*0.37);

      player.x += (tarX-player.x)*CFG.SHIPINERTIA;
      player.y += (tarY-player.y)*CFG.SHIPINERTIA;
      player.x = Math.max(-W*0.39,Math.min(W*0.39,player.x));
      player.y = Math.max(-H*0.28,Math.min(H*0.22,player.y));

      player.cross.x += (tarX-player.cross.x)*0.24 + (Math.random()-0.5)*0.3;
      player.cross.y += (tarY-player.cross.y)*0.24 + (Math.random()-0.5)*0.3;

      if(shootDown && t>game.tLaser+CFG.LASER_COOLDOWN){
        fireLaser();
        game.tLaser = t;
      }

      // Spawn asteroids
      game.lastAst += dt;
      const astLim = CFG.ASTEROIDS + Math.floor(game.score/24);
      while(asteroids.length<astLim && game.lastAst>(1/game.asteroidRate)){
        spawnAsteroid();
        game.lastAst -= 1/game.asteroidRate;
      }

      // Move asteroids
      for(let i=asteroids.length-1;i>=0;--i){
        const a=asteroids[i];
        a.z -= a.speed*dt;
        a.x += a.sx*dt; a.y += a.sy*dt;
        if(a.z<0) asteroids.splice(i,1);
      }

      // Move lasers
      for(let i=lasers.length-1;i>=0;--i){
        const l=lasers[i];
        l.z += l.dz*dt; l.x += l.dx*dt; l.y += l.dy*dt;
        if(l.z>CFG.SCENED) lasers.splice(i,1);
      }

      // Explosions
      for(let i=explosions.length-1;i>=0;--i){
        const e=explosions[i];
        e.t++;
        if(e.t>CFG.EXPLODE_FRAMES) explosions.splice(i,1);
      }

      // Laser–asteroid collisions
      for(let li=lasers.length-1;li>=0;--li){
        const l=lasers[li];
        let hit=false;
        for(let ai=asteroids.length-1;ai>=0;--ai){
          const a=asteroids[ai];
          const dx=a.x-l.x, dy=a.y-l.y, dz=a.z-l.z;
          const dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
          if(dist<a.r*0.94){
            explosions.push({x:a.x,y:a.y,z:a.z,c:a.c,r:a.r,t:0});
            playSfx('explode');
            asteroids.splice(ai,1);
            lasers.splice(li,1);
            game.score+=6+Math.round(a.r*0.5);
            hit=true; break;
          }
        }
        if(hit) break;
      }

      // Asteroid–ship collisions
      for(let ai=asteroids.length-1;ai>=0;--ai){
        const a=asteroids[ai];
        const dx=a.x-player.x, dy=a.y-player.y, dz=a.z;
        const dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
        if(a.z<CFG.SHIPRAD*1.3 && dist<a.r*0.7+CFG.SHIPRAD*0.48){
          explosions.push({x:a.x,y:a.y,z:a.z,c:a.c,r:a.r*1.4,t:0});
          playSfx('hit');
          asteroids.splice(ai,1);
          game.health--; game.inShake=CFG.DODGE_JITTER;
          if(game.health<=0) doGameOver();
        }
      }

      if(game.inShake>0) game.inShake--;

      // Render
      render();
      requestAnimationFrame(loop);
    }

    // --- 3D Rendering Functions ---
    function render(){
      ctx.clearRect(0,0,W,H);
      renderStars(); renderAsteroids();
      renderLasers(); renderExplosions();
      renderCockpit(); renderHud();
    }
    function camProject(x,y,z){
      const fov=CFG.FOV*Math.PI/180;
      const focal=cy/Math.tan(fov/2);
      return {
        x:cx + x*(focal/(z+1)),
        y:cy + CFG.SHIP_Y_BIAS*H + y*(focal/(z+1))
      };
    }
    function sceneToCam(x,y,z){
      return { x:x-player.x, y:y-player.y, z:z };
    }
    // … (renderStars, renderAsteroids, renderExplosions, renderCockpit, renderHud unchanged) …

    // --- Game Entity Functions ---
    function spawnAsteroid(){
      const theta=rand(-Math.PI/2.25,+Math.PI/2.25),
            phi=rand(-Math.PI/5,Math.PI/5),
            z=rand(CFG.AST_MINZ,CFG.AST_MAXZ),
            r=rand(CFG.AST_MINR,CFG.AST_MAXR),
            dist=z;
      let x=Math.sin(theta)*dist*0.49,
          y=Math.sin(phi)*dist*0.26;
      if(Math.random()<0.22 && game.score>40){
        x+=player.x*rand(-0.1,0.32);
        y+=player.y*rand(-0.1,0.33);
      }
      const c=CFG.AST_COLORS[Math.floor(rand(0,CFG.AST_COLORS.length))],
            speed=rand(CFG.AST_MINSPD,CFG.AST_MAXSPD),
            sx=rand(-70,70), sy=rand(-55,55);
      asteroids.push({x,y,z,r,c,speed,sx,sy});
    }

    function fireLaser(){
      playSfx("laser");
      // compute focal length
      const fov   = CFG.FOV * Math.PI/180;
      const focal = cy / Math.tan(fov/2);
      const dz = CFG.LASER_SPEED;
      // map screen offset → world direction
      const dx = player.cross.x * dz / focal;
      const dy = player.cross.y * dz / focal;
      lasers.push({
        x: player.x,
        y: player.y,
        z: 0,
        dx: dx,
        dy: dy,
        dz: dz
      });
    }

    function rand(a,b){ return a+(b-a)*Math.random(); }
    function shade(hex,amt){ /* unchanged */ }
    function clamp(v,m,M){ return Math.max(m,Math.min(M,v)); }

    // --- SFX ---
    function playSfx(type){
      if(!audioCtx){
        window.AudioContext = window.AudioContext||window.webkitAudioContext;
        audioCtx=new AudioContext();
      }
      if(audioCtx.state==='suspended') audioCtx.resume();
      const now=audioCtx.currentTime;
      let o,g,f;
      switch(type){
        case "laser":
          o=audioCtx.createOscillator();
          g=audioCtx.createGain();
          o.type='triangle'; o.frequency.value=520;
          o.connect(g); g.connect(audioCtx.destination);
          g.gain.value=CFG.SFX_VOL;
          g.gain.linearRampToValueAtTime(0.01,now+0.18);
          o.frequency.linearRampToValueAtTime(1100,now+0.06);
          o.frequency.linearRampToValueAtTime(320,now+0.16);
          o.start(now); o.stop(now+0.2);
          break;
        case "explode":
          o=audioCtx.createOscillator();
          g=audioCtx.createGain();
          o.type='square'; o.frequency.value=210;
          f=audioCtx.createBiquadFilter();
          f.type='lowpass'; f.frequency.value=700;
          o.connect(f); f.connect(g); g.connect(audioCtx.destination);
          g.gain.value=CFG.SFX_VOL*0.82;
          g.gain.linearRampToValueAtTime(0.01,now+0.32);
          f.frequency.linearRampToValueAtTime(55,now+0.20);
          o.frequency.linearRampToValueAtTime(70,now+0.22);
          o.start(now); o.stop(now+0.29);
          break;
        case "hit":
          o=audioCtx.createOscillator();
          g=audioCtx.createGain();
          o.type='sawtooth'; o.frequency.value=180;
          o.connect(g); g.connect(audioCtx.destination);
          g.gain.value=CFG.SFX_VOL*0.60;
          g.gain.linearRampToValueAtTime(0.01,now+0.14);
          o.frequency.linearRampToValueAtTime(60,now+0.11);
          o.start(now); o.stop(now+0.16);
          break;
      }
    }

    // --- UI & Boot ---
    UI.shoot.addEventListener('touchstart',e=>{ shootDown=true; e.preventDefault(); },{passive:false});
    UI.shoot.addEventListener('mousedown',e=>{ shootDown=true; e.preventDefault(); });
    ['mouseup','mouseleave','touchend','touchcancel']
      .forEach(ev=>UI.shoot.addEventListener(ev,()=>{ shootDown=false; },{passive:false}));

    canvas = document.getElementById('canvas');
    canvas.addEventListener('touchstart', e=>{
      if(e.touches[0].clientY>H*0.76 && !calibrating && !gameover){
        beginCalibration();
        showHelp("Calibration: Hold forward, then tap.",1800);
      }
    },{passive:true});

    UI.restartBtn.onclick = ()=>{
      startNewGame();
      UI.gameover.style.display='none';
    };

    function doGameOver(){
      game.running=false;
      gameover=true;
      UI.finalscore.textContent="SCORE: "+game.score;
      setTimeout(()=>{ UI.gameover.style.display='flex'; },300);
      playSfx("explode");
    }

    function startNewGame(){
      t0=tPrev=0; gameover=false;
      UI.gameover.style.display='none';
      UI.help.style.display='none';
      initGame();
      player.x=player.y=0;
      requestAnimationFrame(loop);
    }

    function resizeIfNeeded(){
      if(canvas.width!==innerWidth*window.devicePixelRatio ||
         canvas.height!==innerHeight*window.devicePixelRatio){
        DPR=window.devicePixelRatio||1;
        W=window.innerWidth; H=window.innerHeight;
        cx=W/2; cy=H/2; minWH=Math.min(W,H);
        canvas.width=W*DPR; canvas.height=H*DPR;
        canvas.style.width=W+"px"; canvas.style.height=H+"px";
        ctx.setTransform(1,0,0,1,0,0); ctx.scale(DPR,DPR);
      }
    }

    function showHelp(txt,ms=1300){
      UI.help.textContent=txt;
      UI.help.style.display="block";
      clearTimeout(helpTimeout);
      helpTimeout=setTimeout(()=>{ UI.help.style.display="none"; },ms);
    }

    function boot(){
      canvas=document.getElementById('canvas');
      ctx=canvas.getContext('2d',{alpha:false});
      resizeIfNeeded();
      window.addEventListener('resize',resizeIfNeeded);
      document.body.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});
      document.body.addEventListener('gesturestart',e=>e.preventDefault(),{passive:false});
      initGame();
      requireDeviceMotionPermission();
      showHelp("Tilt to steer, TAP shoot. Tap cockpit to recalibrate.",2600);
      requestAnimationFrame(loop);
    }

    if(document.readyState==='complete' || document.readyState==='interactive'){
      setTimeout(boot,0);
    } else {
      window.addEventListener('load',boot);
    }
  </script>
</body>
</html>