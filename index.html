<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mobile FP Space Shooter</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<style>
html,body {margin:0;padding:0;width:100vw;height:100vh;background:#0a172c;overflow:hidden;touch-action:none;}
#canvas {
  position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;display:block;pointer-events:none;
}
#ui {
  position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:7;pointer-events:none;font-family:Orbitron,monospace,Arial,sans-serif;
}
#shoot {
  position:fixed;right:7vw;bottom:12vh;width:22vw;height:22vw;min-width:70px;min-height:70px;max-width:128px;max-height:128px;
  background:linear-gradient(135deg,#27b2e7 65%,#0a2e4e 95%);border-radius:50%;border:2px solid #9cfffc;
  font-size:1.3em;color:#f5ffff;letter-spacing:.1em;font-weight:bold;text-shadow:0 2px 12px #3afcff96;
  box-shadow:0 1px 16px #42e5f755;pointer-events:auto;outline:none;
  opacity:0.88;
}
#shoot:active {opacity:1;background:#9aecff;}
#overlay, #gameover, #calibrate {
  position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9;pointer-events:auto;
  background:rgba(10,24,44,.96);display:flex;align-items:center;justify-content:center;flex-direction:column;
  font-family:Orbitron,monospace,Arial,sans-serif;font-size:1.15em;color:#e4ffff;text-align:center;
  user-select:none;-webkit-user-select:none;
}
#overlay, #gameover, #calibrate {display:none;}
.overlay-btn {
  background:#2beafc;color:#fff;font-size:1.1em;padding:.5em 2em;border:0;border-radius:.4em;
  margin-top:1em;box-shadow:0 0 16px #43f3ff80;
}
.info {
  position:fixed;left:7vw;bottom:8vw;font-size:.93em;color:#95e8ff67;z-index:8;pointer-events:none;
  text-shadow:0 2px 9px #1cf6ff40;
}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="ui">
  <button id="shoot">FIRE</button>
  <div class="info" id="helpInfo"></div>
</div>
<div id="overlay">
  <h2 style="font-size:2em;color:#5eeccf;">SPACE SHOOTER</h2>
  <div style="margin:.9em 0 1.6em 0;font-size:1.15em;">
  <b>Enable Motion on your Device</b><br>
  Tap to allow tilt-controls (iOS/Android).<br>
  Hold device as you want to aim.<br>
  </div>
  <button class="overlay-btn" id="permBtn">ENABLE MOTION</button>
</div>
<div id="calibrate">
  <h3 style="font-size:1.5em;color:#69f2e9;">Calibrate</h3>
  <div style="margin:.8em 0 1.2em 0;">
    Hold device FORWARD as you play.<br>
    <b>Tap to calibrate zero point.</b>
  </div>
  <button class="overlay-btn" id="calibBtn">Set Forward</button>
</div>
<div id="gameover">
  <div style="font-size:2.4em;color:#ff8f98;text-shadow:0 0 20px #fff3;">GAME OVER</div>
  <div id="finalscore" style="font-size:1.2em;margin-bottom:1.5em;margin-top:.7em;"></div>
  <button class="overlay-btn" id="restartBtn">TAP TO RESTART</button>
</div>
<script>
/*
Mobile-Optimized 3D FP Space Shooter
 - True 3D 'flight' controls (your ship moves/steers, not just 'aim')
 - Asteroids/enemies pass by in full 3D, lasers fire from your position
 - DeviceOrientation with calibration, smooth movement
 - Fully procedural visuals and SFX (no assets)
By @jdanek920, MIT, 2024+, no dependencies.
*/

// --- Config ---
const CFG = {
  FOV: 62,      // vertical field-of-view in degrees
  SENS: 1.0,    // device tilt-to-movement multiplier
  SCENED: 2000, // scene viewable depth (px units)
  SHIPRAD: 34,  // ship hull collision approx (px at z=0)
  SHIPSPEED: 142, // max ship speed screen px/sec (strafe/updown)
  SHIPINERTIA: .12, // movement smoothing, higher=slower
  SHIP_Y_BIAS: .11, // ship is below screen center (cockpit feel)
  LASER_COOLDOWN: 0.18, // seconds
  LASER_SPEED: 1700,    // px/sec, in scene
  LASER_LENGTH: 170,    // px in 3D (z-axis)
  STARS: 84,      // parallax star amount
  ASTEROIDS: 7,   // how many concurrently
  AST_BIRATE: 1.13,// base spawn per sec
  AST_MINZ: 660,  // asteroids start at least this far ahead (px scene)
  AST_MAXZ: 1160,
  AST_MINR: 32,   // min asteroid radius (scene units)
  AST_MAXR: 66,
  AST_MINSPD: 440, AST_MAXSPD: 690,
  AST_COLORS: ['#8cf7ff','#cab9ad','#aeaedb','#abf1e1','#eed7ba','#efacb0','#b9e4e8'],
  EXPLODE_FRAMES: 18,
  PLAYER_HEALTH: 4,
  COCKPIT_H: .17, // screen height fraction
  DODGE_JITTER: 8, // cockpit screen shake
  SFX_VOL: 0.21
};

// --- Globals ---
let canvas, ctx, DPR, W, H, cx, cy, minWH;
let stars, asteroids, lasers, explosions;
let game, player, t0, tPrev;
let deviceOk = false, calibrating = false, gameover = false, canFire = false;
let orientationZero = {beta:0, gamma:0}, haveInput = false;
let shootDown = false;
let audioCtx = null;
let helpTimeout;

// --- UI ---
const UI = {
  overlay: document.getElementById('overlay'),
  permBtn: document.getElementById('permBtn'),
  calibrate: document.getElementById('calibrate'),
  calibBtn: document.getElementById('calibBtn'),
  gameover: document.getElementById('gameover'),
  finalscore: document.getElementById('finalscore'),
  restartBtn: document.getElementById('restartBtn'),
  shoot: document.getElementById('shoot'),
  help: document.getElementById('helpInfo')
};

// ----------------------------------
// 1. Device Orientation Input/Mapping
// ----------------------------------

function requireDeviceMotionPermission() {
  // iOS 13+ needs permission prompt
  if (typeof DeviceOrientationEvent == 'undefined') {
    UI.overlay.style.display = 'flex';
    UI.permBtn.innerText = 'Device motion not supported';
    UI.permBtn.disabled = true;
    return;
  }
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    UI.overlay.style.display = 'flex';
    UI.permBtn.onclick = function() {
      DeviceOrientationEvent.requestPermission().then(res => {
        if (res==="granted") {
          UI.overlay.style.display='none';
          deviceOk = true;
          beginCalibration();
        }
      });
    }
  } else {
    // Android: always on, no prompt
    deviceOk = true;
    UI.overlay.style.display='none';
    beginCalibration();
  }
}

window.addEventListener('deviceorientation', handleOrient, true);

function handleOrient(evt) {
  // beta (pitch up/down), gamma (roll/tilt left/right)
  haveInput = true;
  player.lastRaw.beta  = evt.beta   || 0;
  player.lastRaw.gamma = evt.gamma  || 0;
  player.lastRaw.alpha = evt.alpha  || 0;
}
function beginCalibration() {
  calibrating = true;
  UI.calibrate.style.display = 'flex';
}
UI.calibBtn.onclick = function() {
  orientationZero.beta  = player.lastRaw.beta;
  orientationZero.gamma = player.lastRaw.gamma;
  calibrating = false;
  UI.calibrate.style.display = 'none';
};
function recalibrate() {
  beginCalibration();
  showHelp("Calibration: Hold forward, then tap.", 1800);
}

//----------------------------------
// 2. Game State
//----------------------------------
function initGame() {
  // Game stats and entities
  game = {
    running: true, score: 0, health: CFG.PLAYER_HEALTH,
    astCounter: 0, lastAst: 0, asteroidRate: CFG.AST_BIRATE, 
    tLaser: -9, explosions: 0, inShake: 0
  };
  player = {
    // 3D position of ship (in scene, x=left, y=up, z is 0 [camera base])
    x:0, y:0, z:0,
    vx:0, vy:0,
    cross: {x:0,y:0},
    lastRaw:{beta:0,gamma:0,alpha:0}
  };
  lasers = [];
  asteroids = [];
  explosions = [];
  // starfield
  stars = [];
  for(let i=0;i<CFG.STARS;++i) {
    let s = {
      x: (Math.random()-0.5)*1.8*W,
      y: (Math.random()-0.5)*1.5*H,
      z: 0.22 + 0.78*Math.random(),
      r: Math.random()*1.7+0.7,
      c: Math.random()<0.91?'#cceeff':'#6fddff'
    }; stars.push(s);
  }
}

//----------------------------------
// 3. Main Loop & Physics
//----------------------------------

function loop(ts) {
  if (!t0) t0 = tPrev = ts/1000;
  let t = ts/1000, dt = Math.min(1/30, t-tPrev); tPrev = t;
  resizeIfNeeded();

  if (!deviceOk || calibrating) return requestAnimationFrame(loop);
  if (!game.running) { render(); return; }

  // -- Map orientation to movement target --
  let g = player.lastRaw;
  let dBeta = (g.beta - orientationZero.beta);
  let dGamma= (g.gamma- orientationZero.gamma);

  // For phones flat: up/down is beta, left/right is gamma; adjust for both
  // Clamp for comfort
  let maxBeta = 34, maxGamma = 38;
  dBeta  = Math.max(-maxBeta, Math.min(maxBeta, dBeta));
  dGamma = Math.max(-maxGamma, Math.min(maxGamma, dGamma));

  // Map to motion in ship-space (strafe up/down & left/right)
  // You want tilting to “push” crosshair, so invert physically:
  let tarY = -dBeta  / maxBeta  * (H * 0.35);
  let tarX =  dGamma / maxGamma * (W * 0.37);

  // Smooth inertia
  player.x += (tarX - player.x) * CFG.SHIPINERTIA;
  player.y += (tarY - player.y) * CFG.SHIPINERTIA;

  // Speed cap (screen edges); clamp so never crosses view
  player.x = Math.max(-W*0.39, Math.min(W*0.39, player.x));
  player.y = Math.max(-H*0.28, Math.min(H*0.22, player.y));

  // Crosshair tracks last setpoint for "smooth aiming" and feedback
  player.cross.x += (tarX-player.cross.x)*0.24 + (Math.random()-0.5)*0.3;
  player.cross.y += (tarY-player.cross.y)*0.24 + (Math.random()-0.5)*0.3;

  // -- Fire lasers --
  if (shootDown && (t>game.tLaser+CFG.LASER_COOLDOWN)) {
    fireLaser();
    game.tLaser = t;
  }

  // -- Spawn asteroids (ahead in 3D) --
  game.lastAst += dt;
  let astLim = CFG.ASTEROIDS + Math.floor(game.score/24);
  while (asteroids.length<astLim && game.lastAst > (1/game.asteroidRate)) {
    spawnAsteroid();
    game.lastAst -= (1/game.asteroidRate);
  }
  // -- Move asteroids forward towards player
  for(let i=asteroids.length-1;i>=0;--i){
    let a = asteroids[i];
    a.z -= a.speed * dt;
    // Sway asteroids slightly for challenge
    a.x += a.sx * dt;
    a.y += a.sy * dt;
    if (a.z<0) asteroids.splice(i,1);
  }
  // -- Lasers move in 3D
  for(let i=lasers.length-1;i>=0;--i){
    let l = lasers[i];
    l.z += l.dz*dt; l.x += l.dx*dt; l.y += l.dy*dt;
    if (l.z>CFG.SCENED) lasers.splice(i,1);
  }
  // -- Explosions
  for(let i=explosions.length-1;i>=0;--i){
    let e = explosions[i];
    e.t++;
    if (e.t > CFG.EXPLODE_FRAMES) explosions.splice(i, 1);
  }

  // -- Collisions: Laser/Asteroid
  for(let li=lasers.length-1;li>=0;--li) {
    let l = lasers[li], hit=false;
    for(let ai=asteroids.length-1;ai>=0;--ai) {
      let a = asteroids[ai];
      let dx=a.x-l.x, dy=a.y-l.y, dz=a.z-l.z;
      let dist = Math.sqrt(dx*dx+dy*dy+dz*dz);
      if (dist < a.r*0.94) {
        explosions.push({
          x:a.x,y:a.y,z:a.z,c:a.c,r:a.r,t:0
        });
        playSfx('explode');
        asteroids.splice(ai, 1);
        lasers.splice(li, 1);
        game.score += 6+Math.round(a.r*0.5);
        hit=true; break;
      }
    }
    if(hit) break;
  }
  // -- Collisions: Asteroid/Ship
  for(let ai=asteroids.length-1;ai>=0;--ai) {
    let a = asteroids[ai];
    let dx=a.x-player.x, dy=a.y-player.y, dz=a.z;
    let dist = Math.sqrt(dx*dx+dy*dy+dz*dz);
    if (a.z<CFG.SHIPRAD*1.3 && dist < a.r*0.7+CFG.SHIPRAD*0.48) {
      explosions.push({x:a.x,y:a.y,z:a.z,c:a.c,r:a.r*1.4,t:0});
      playSfx('hit');
      asteroids.splice(ai, 1);
      game.health--;
      game.inShake = CFG.DODGE_JITTER;
      if (game.health<=0) { doGameOver(); }
    }
  }
  if (game.inShake>0) game.inShake--;

  // --- Render ---
  render();

  requestAnimationFrame(loop);
}


// -----------------------------------
// 4. 3D Rendering
// -----------------------------------
function render() {
  ctx.clearRect(0,0,W,H);
  renderStars();
  renderAsteroids();
  renderLasers();
  renderExplosions();
  renderCockpit();
  renderHud();
}

function camProject(x,y,z) {
  // Simple pinhole camera: maps 3D scene (player relative) to screen
  let fov = CFG.FOV*Math.PI/180;
  let focal = cy / Math.tan(fov/2);
  let sx = cx + (x)*(focal/(z+1));
  let sy = cy + CFG.SHIP_Y_BIAS*H + (y)*(focal/(z+1));
  return {x:sx, y:sy};
}
function sceneToCam(x,y,z) {
  // Transform scene coords to camera-relative (player offset)
  return {x: x-player.x, y: y-player.y, z: z};
}
function renderStars() {
  let px=player.x, py=player.y;
  for(let i=0;i<stars.length;++i){
    let s=stars[i];
    let sx = cx + s.x*s.z - px*s.z*0.15;
    let sy = cy + s.y*s.z + CFG.SHIP_Y_BIAS*H - py*s.z*0.11;
    ctx.globalAlpha = .30* s.z;
    ctx.beginPath();ctx.arc(sx,sy,s.r,0,2*Math.PI);
    ctx.fillStyle = s.c;
    ctx.fill();
  }
  ctx.globalAlpha=1;
}
function renderAsteroids() {
  for(let i=0;i<asteroids.length;++i) {
    let a = asteroids[i];
    let c = sceneToCam(a.x,a.y,a.z);
    let pt = camProject(c.x, c.y, c.z);
    let sz = a.r * Math.max(0.20, cx/(c.z+1)/350);
    // Core body
    ctx.save(); ctx.beginPath();
    ctx.arc(pt.x,pt.y,sz,0,2*Math.PI);
    let g = ctx.createRadialGradient(pt.x,pt.y,sz*0.4,pt.x,pt.y,sz);
    g.addColorStop(0.0,a.c);
    g.addColorStop(0.7,shade(a.c,-0.24));
    g.addColorStop(1.0,"#0d193e");
    ctx.fillStyle = g;
    ctx.shadowColor = shade(a.c,0.08);
    ctx.shadowBlur = 12+sz*0.5;
    ctx.globalAlpha = Math.max(0.29,Math.min(1.00,(1400-a.z)/900));
    ctx.fill();
    ctx.restore();
    ctx.globalAlpha=1;
    // Small sci-fi marks
    if(Math.random()<.18){
      ctx.beginPath();
      ctx.arc(pt.x+sz*.6*(Math.random()-.5),pt.y+sz*.6*(Math.random()-.5),sz*rand(0.13,0.24),0,2*Math.PI);
      ctx.fillStyle = rand(0,1)<.5?"#fff9":"#eefb";
      ctx.globalAlpha=.14;
      ctx.fill(); ctx.globalAlpha=1;
    }
  }
}
function renderLasers() {
  for(let i=0;i<lasers.length;++i){
    let l=lasers[i];
    let c0=sceneToCam(l.x, l.y, l.z);
    let c1=sceneToCam(l.x+l.dx*0.11, l.y+l.dy*0.11, l.z+l.dz*0.11);
    let pt0 = camProject(c0.x,c0.y,c0.z), pt1=camProject(c1.x,c1.y,c1.z);
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(pt0.x,pt0.y); ctx.lineTo(pt1.x,pt1.y);

    ctx.lineWidth=Math.max(2.2,8/(l.z/330+1.2));
    ctx.strokeStyle="#befcff";
    ctx.shadowColor="#23ffff";
    ctx.shadowBlur=12;
    ctx.globalAlpha=.83;
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(pt0.x,pt0.y,Math.max(1.9,4/(l.z/300+1.2)),0,2*Math.PI);
    ctx.fillStyle="#fff";
    ctx.globalAlpha=.39;
    ctx.fill();
    ctx.globalAlpha=1;
    ctx.restore();
  }
}
function renderExplosions() {
  for(let i=0;i<explosions.length;++i){
    let e = explosions[i];
    let c = sceneToCam(e.x,e.y,e.z);
    let pt = camProject(c.x,c.y,c.z);
    let fr = e.t / CFG.EXPLODE_FRAMES;
    let sz = e.r * (1 + fr*1.3);
    let g = ctx.createRadialGradient(pt.x,pt.y,0.2,pt.x,pt.y,sz);
    g.addColorStop(0.0,"#fffec0");
    g.addColorStop(.25,e.c);
    g.addColorStop(.80, "rgba(220,240,255,0.14)");
    g.addColorStop(1.0,"#11275000");
    ctx.globalAlpha = Math.max(0,0.46 - 0.33*fr*fr);
    ctx.beginPath();
    ctx.arc(pt.x,pt.y,sz,0,2*Math.PI);
    ctx.fillStyle = g;
    ctx.fill();
    ctx.globalAlpha=1;
  }
}
function renderCockpit() {
  // Cockpit glass, with jitter if hit!
  ctx.save();
  let y0 = H*(1-CFG.COCKPIT_H), y1 = H, x0 = cx-minWH*0.39, x1 = cx+minWH*0.39;
  let dx=0,dy=0;
  if (game.inShake>0) { dx=rand(-5,5); dy=rand(-8,5); }
  ctx.beginPath();
  ctx.moveTo(x0+dx,y1+dy);
  ctx.bezierCurveTo(x0-50+dx, y1+dy, cx-60+dx, y0-13+dy, cx+dx, y0-16+dy);
  ctx.bezierCurveTo(cx+60+dx, y0-13+dy, x1+50+dx, y1+dy, x1+dx, y1+dy);
  ctx.lineTo(cx+dx,y1+dy);
  ctx.closePath();
  let cg = ctx.createLinearGradient(cx,y0-10,cx,H);
  cg.addColorStop(.05,"#153556");cg.addColorStop(.4,"#3ab6b64b");
  cg.addColorStop(.78,"#7fd9fcea");cg.addColorStop(1,"#1e2641c8");
  ctx.globalAlpha=.38;
  ctx.fillStyle = cg; ctx.fill();
  ctx.globalAlpha=1;
  ctx.restore();

  // Ship/Crosshair
  let chSize = minWH*0.07;
  ctx.save();
  let chx = cx+player.cross.x, chy=cy+CFG.SHIP_Y_BIAS*H+player.cross.y;
  // Sides
  ctx.lineWidth=2.1;
  ctx.strokeStyle="#8cfaff";
  ctx.beginPath();
  ctx.arc(chx,chy, chSize, 0, 2*Math.PI);
  ctx.moveTo(chx-chSize*1.13, chy);
  ctx.lineTo(chx-chSize*0.42, chy);
  ctx.moveTo(chx+chSize*1.13, chy);
  ctx.lineTo(chx+chSize*0.42, chy);
  ctx.moveTo(chx, chy-chSize*1.13);
  ctx.lineTo(chx, chy-chSize*0.42);
  ctx.moveTo(chx, chy+chSize*1.13);
  ctx.lineTo(chx, chy+chSize*0.42);
  ctx.globalAlpha=0.82;
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(chx, chy, 3.1, 0, 2*Math.PI);
  ctx.globalAlpha=.36;
  ctx.fillStyle="#fff";
  ctx.fill();
  ctx.globalAlpha=1;
  ctx.restore();
}
function renderHud() {
  // Score
  ctx.save();
  ctx.font = `bold ${Math.floor(minWH*0.052)}px Orbitron,monospace`;
  ctx.fillStyle="#6bf8ff";
  ctx.shadowColor="#32feffa4";ctx.shadowBlur=18;
  ctx.textAlign="left"; ctx.textBaseline="top";
  ctx.fillText("SCORE "+game.score, W*0.08, H*0.03);
  ctx.shadowBlur=0;

  // Health bar
  let barW = minWH*0.38, barH = minWH*0.031;
  let x= cx-barW/2, y=H*0.09;
  ctx.lineJoin="round";
  ctx.lineWidth=barH;
  let gg = ctx.createLinearGradient(x,0,x+barW,0);
  gg.addColorStop(0,"#3bf8fa");gg.addColorStop(.49,"#b1faff");
  gg.addColorStop(.72, game.health>2?'#77fa7b':'#f7e72f');
  gg.addColorStop(1.0, game.health<=1?'#f83262':'#3494ff');
  ctx.strokeStyle=gg;
  ctx.beginPath();
  ctx.moveTo(x,y);
  ctx.lineTo(x+barW*(game.health/CFG.PLAYER_HEALTH),y);
  ctx.shadowColor="#abffff";ctx.shadowBlur=8;
  ctx.globalAlpha=.89;
  ctx.stroke();
  ctx.shadowBlur=0;ctx.globalAlpha=1;
  ctx.beginPath();
  ctx.lineWidth=1.2;
  ctx.strokeStyle="#e1f9fe7c";
  ctx.moveTo(x,y); ctx.lineTo(x+barW,y);
  ctx.stroke();
  ctx.restore();
}

// -------- HUD helpers -------
function showHelp(txt, ms=1300) {
  UI.help.textContent=txt;
  UI.help.style.display="block";
  clearTimeout(helpTimeout);
  helpTimeout = setTimeout(()=>UI.help.style.display="none",ms);
}


// -----------------------------------
// 5. Entities
//------------------------------------
function spawnAsteroid() {
  let theta = rand(-Math.PI/2.25, +Math.PI/2.25); // horizontal
  let phi   = rand(-Math.PI/5, Math.PI/5); // vertical
  let z = rand(CFG.AST_MINZ, CFG.AST_MAXZ);
  let r = rand(CFG.AST_MINR, CFG.AST_MAXR);
  let dist = z, 
      x = Math.sin(theta)*dist*0.49,
      y = Math.sin(phi)*dist*0.26;
  // Add a rare "direct line" asteroid
  if (Math.random()<.22 && game.score>40)
    { x += player.x*rand(-0.1,0.32); y+=player.y*rand(-0.1,0.33); }
  let c = CFG.AST_COLORS[Math.floor(rand(0,CFG.AST_COLORS.length))];
  let speed = rand(CFG.AST_MINSPD, CFG.AST_MAXSPD);
  let sx = rand(-70,70), sy=rand(-55,55);
  asteroids.push({x:x,y:y,z:z,r:r,c:c, speed:speed, sx:sx,sy:sy});
}
function fireLaser() {
  // Laser launches straight from ship's current 3D position
  playSfx("laser");
  let dir = { dx:0, dy:0, dz:CFG.LASER_SPEED };
  lasers.push({
    x:player.x, y:player.y, z:0,
    dx:dir.dx, dy:dir.dy, dz:dir.dz
  });
}
function rand(a,b) { return a+(b-a)*Math.random(); }
function shade(hex,amt) {
  // shade #rgb or #rrggbb hex by amt (-.2..+.2)
  let h=hex.replace('#',''),n=parseInt(h,16),f= h.length<6?17:1,r=((n>>16)&255)*f,g=((n>>8)&255)*f,b=(n&255)*f;
  r=clamp(Math.round(r*(1+amt)),0,255);
  g=clamp(Math.round(g*(1+amt)),0,255);
  b=clamp(Math.round(b*(1+amt)),0,255);
  return `rgb(${r},${g},${b})`;
}
function clamp(a,x,y) { return Math.max(x,Math.min(y,a)); }

//----------------------------------
// 6. SFX
//----------------------------------
function playSfx(type) {
  if (!audioCtx) {
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AudioContext();
  }
  if (audioCtx.state==='suspended') audioCtx.resume();
  let now = audioCtx.currentTime, o, g;
  switch(type) {
    case "laser":
      o=audioCtx.createOscillator();g=audioCtx.createGain();
      o.type='triangle'; o.frequency.value=520;
      o.connect(g);g.connect(audioCtx.destination);
      g.gain.value=CFG.SFX_VOL;
      g.gain.linearRampToValueAtTime(0.01, now+0.18);
      o.frequency.linearRampToValueAtTime(1100, now+0.06);
      o.frequency.linearRampToValueAtTime(320, now+0.16);
      o.start(now); o.stop(now+0.2); break;
    case "explode":
      o=audioCtx.createOscillator();g=audioCtx.createGain();
      o.type='square';o.frequency.value=210;
      let f=audioCtx.createBiquadFilter();
      f.type='lowpass';f.frequency.value=700;
      o.connect(f);f.connect(g);g.connect(audioCtx.destination);
      g.gain.value=CFG.SFX_VOL*0.82;
      g.gain.linearRampToValueAtTime(0.01,now+0.32);
      f.frequency.linearRampToValueAtTime(55,now+0.20);
      o.frequency.linearRampToValueAtTime(70,now+0.22);
      o.start(now); o.stop(now+0.29); break;
    case "hit":
      o=audioCtx.createOscillator();g=audioCtx.createGain();
      o.type='sawtooth'; o.frequency.value=180;
      o.connect(g);g.connect(audioCtx.destination);
      g.gain.value=CFG.SFX_VOL*0.60;
      g.gain.linearRampToValueAtTime(0.01, now+0.14);
      o.frequency.linearRampToValueAtTime(60, now+0.11);
      o.start(now); o.stop(now+0.16); break;
  }
}

// ---------------------------------
// 7. Overlays, UI, Restart, Resize
//----------------------------------
UI.shoot.addEventListener('touchstart',e=>{ shootDown=true; e.preventDefault();}, {passive:false});
UI.shoot.addEventListener('mousedown',e=>{shootDown=true; e.preventDefault();});

['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>
  UI.shoot.addEventListener(ev,()=>shootDown=false,{passive:false})
);

// Tap cockpit ("bottom quarter") to recalibrate anytime
canvas = document.getElementById('canvas');
canvas.addEventListener('touchstart', function(e) {
  let y = e.touches[0].clientY;
  if (y>H*0.76 && !calibrating && !gameover) { recalibrate(); }
}, {passive:true});

// Overlays/buttons
UI.restartBtn.onclick = ()=>{ startNewGame(); UI.gameover.style.display='none'; };
function doGameOver() {
  game.running=false; gameover=true;
  UI.finalscore.textContent = "SCORE: "+game.score;
  setTimeout(()=>UI.gameover.style.display='flex',300);
  playSfx("explode");
}
function startNewGame() {
  t0=tPrev=0; gameover=false; UI.gameover.style.display='none';
  UI.help.style.display='none';
  initGame(); player.x=player.y=0; // centered
  requestAnimationFrame(loop);
}

// Responsive sizing
function resizeIfNeeded() {
  if(canvas.width!==innerWidth*window.devicePixelRatio || canvas.height!==innerHeight*window.devicePixelRatio) {
    DPR = window.devicePixelRatio || 1;
    W = window.innerWidth; H=window.innerHeight;
    cx=W/2;cy=H/2; minWH=Math.min(W,H);
    canvas.width=W*DPR; canvas.height=H*DPR;canvas.style.width=W+"px";canvas.style.height=H+"px";
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(DPR,DPR);
  }
}

// ============ BOOT =========
function boot() {
  canvas = document.getElementById('canvas');
  ctx = canvas.getContext('2d',{alpha:false});
  resizeIfNeeded();
  window.addEventListener('resize', resizeIfNeeded);
  // Prevent unwanted page gesture/scroll
  document.body.addEventListener('touchmove', e=>e.preventDefault(), {passive:false});
  document.body.addEventListener('gesturestart', e=>e.preventDefault(), {passive:false});
  // Initialize
  initGame();
  requireDeviceMotionPermission();
  showHelp("Tilt to steer, TAP shoot. Tap cockpit recalibrate.",2600);
  requestAnimationFrame(loop);
}

// ============ Start =========
if(document.readyState==='complete'||document.readyState==='interactive')
  setTimeout(boot,0);
else window.addEventListener('load',boot);

</script>
</body>
</html>
